### 欢迎关注我的微信公众号：Hypochondria 
![公众号二维码](https://github.com/user-attachments/assets/2f8e41fb-e990-4fef-825a-d1b86fba7c3f)

### 以及我的知乎主页：https://www.zhihu.com/people/yang-shi-lei-62-72
---

本文梳理下笔者对`Colmap`的各个算法模块的理解，不涉及具体细节。如有错误，欢迎评论指出。

---
# 介绍
>`Colmap`算法的输入为一组图像，输出为相机姿态及稀疏的点云。如图1所示，算法主要分成对应点搜索和增量重建两大模块。

![图1.Colmap算法的整体框架](https://files.mdnice.com/user/73004/7f72239f-eb0d-4a92-ac08-1c83c909b61c.png)


# 一.对应点搜索
>输入为一组图片，输出为场景图（`scene graph`）。
## 1. 特征提取
在图像上提取sift特征，包含特征点检测和特征点描述。
## 2. 特征匹配
使用提取的特征点描述子进行匹配，有暴力匹配、顺序匹配、空间匹配、传递性匹配（比如a-b是一对图像，b-c是一对图形，那么a-c也是一对图像）、自定义匹配等，得到一组包含重叠场景的潜在图像对及它们之间的点对应关系。**注：这里会构建对应点的轨迹（`tracks`），即场景中同一个点在多张图像之间的对应关系。**

![图2.track的含义](https://files.mdnice.com/user/73004/fd456fb3-8b1a-414a-b23f-a4e3b03ea75d.png)

## 3. 几何验证
利用几何一致性过滤错误匹配，一种是通过估计单应性变换和对极几何（基础矩阵+本质矩阵），根据内点个数、三角化点角度等进行过滤，另一种是针对网络图片中存在的水印(`watermarks`)/时间戳(`timestamps`)/镶边(`frames`)问题的图像对进行过滤  。此外，还会标注图像对对应的场景类型：常规（`general`）、全景（`panoramic`）和平面（`planar`），后续只处理常规和平面的类型。这一步可输出得到场景图，其节点为图像，边由经过几何验证后的图像对确定。**注：这里过滤既包含误匹配点对，也包含了误匹配图像对。**

# 二.增量重建
>输入为场景图，输出为相机姿态及稀疏的点云。

## 1.初始化
选取场景图中相机间可视区域多的两视角进行初始化，利用对极几何关系，计算得到基础矩阵或本质矩阵，并进一步分解得到相机姿态，最后三角化得到三维点。
## 2.图像配准（`Image registratio`）
首先挑选新的图像，然后利用已三角化的三维点和新图像的二维点（利用到上述提及到的轨迹），求解`PNP`问题，得到新图像的相机位姿。关于如何选择一个最佳的新图像，`Colmap`设计了一种多尺度统计点分布点算法，不光考虑可见点的数量，还考虑可见点的分布均匀情况。
## 3.三角化（`Triangulation`）
当知道两幅图像之间的相机姿态变换关系，即利用三角化的方法可得到新的三维点（除去上步的3d-2d匹配对，还有残余的2d-2d匹配对，它们共享相同的相机姿态，因此可进行三角化恢复得到新的点），从而覆盖了更多的场景。这里`Colmap`应该涉及到了两类三角化方法，一种是常规的两视图三角化，另一种是多视图三角化。**这里的多视图三角化是作用在轨迹上，基于'loransac'算法（ransac算法的一种改进）进行构建，用于找到最多数量的可靠两视图三角化（可靠指角度，深度，重投影误差都符号要求）。此外，注意到由于错误匹配的关系一条轨迹可能包括多个潜在的三维点，这里在用`loransac`计算得到最优解之后，会对余下当前轨迹未采用的部分继续递归的求解。**
## 4.捆绑调整（`BA`）
基于最小化重投影误差的思想构建非线性最小二乘优化问题，同时优化多个相机姿态和多个三维点，从而减少整个系统的偏移（`drift`）问题。Colmap在图像配准和三角化之后执行局部`BA`，当模型增长到一定比例时进行一次全局`BA`，并且是迭代的进行BA、重三角化和错误观测点过滤三个步骤。此外，`Colmap`基于共视点构建了一个度量方法将具有高重合度的图像分为一组，组内的图像会共用相机参数，从而减少捆绑调整的参数量。


